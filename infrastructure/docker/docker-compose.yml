version: '3.8'

services:
  # ================================
  # API Service (Rust)
  # ================================
  api:
    build:
      context: ../..
      dockerfile: infrastructure/docker/Dockerfile.dev
    container_name: sky-genesis-api
    ports:
      - "8080:8080"
    environment:
       - DATABASE_URL=postgresql://postgres:password@postgres:5432/api_service
       - DATABASE_URL=postgresql://postgres:password@postgres:5432/api_service
       - VAULT_ADDR=http://vault:8200
       - KEYCLOAK_URL=http://keycloak:8080
       - REDIS_URL=redis://redis:6379
       - JWT_SECRET=development_secret_key_change_in_production
       - RUST_LOG=debug
       - APP_ENV=development
       - STALWART_URL=http://stalwart:8080
    depends_on:
      postgres:
        condition: service_healthy
      vault:
        condition: service_healthy
      redis:
        condition: service_started
    volumes:
      - ../../api:/api:cached
    networks:
      - sky-genesis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ================================
  # Frontend Service (Next.js)
  # ================================
  frontend:
    build:
      context: ../..
      dockerfile: infrastructure/docker/Dockerfile.frontend.dev
    container_name: sky-genesis-frontend
    ports:
      - "3000:3000"
    environment:
      - API_URL=http://api:8080
      - NEXT_PUBLIC_API_URL=http://localhost:8080
      - NODE_ENV=development
    depends_on:
      - api
    volumes:
      - ../../app:/app:cached
      - /app/node_modules
      - /app/.next
    networks:
      - sky-genesis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ================================
  # Database (PostgreSQL)
  # ================================
  postgres:
    image: postgres:15-alpine
    container_name: sky-genesis-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=api_service
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../../data/schema-pgsql.sql:/docker-entrypoint-initdb.d/01-schema.sql
    networks:
      - sky-genesis
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d api_service"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================
  # Secrets Management (Vault)
  # ================================
  vault:
    image: vault:1.15
    container_name: sky-genesis-vault
    ports:
      - "8200:8200"
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=root
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
      - VAULT_LOG_LEVEL=info
    cap_add:
      - IPC_LOCK
    volumes:
      - vault_data:/vault/data
      - ./vault-config.hcl:/vault/config/vault-config.hcl
    networks:
      - sky-genesis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ================================
  # Cache (Redis)
  # ================================
  redis:
    image: redis:7-alpine
    container_name: sky-genesis-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - sky-genesis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # ================================
  # Identity Management (Keycloak)
  # ================================
  keycloak:
    image: quay.io/keycloak/keycloak:22.0
    container_name: sky-genesis-keycloak
    ports:
      - "8081:8080"
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://postgres:5432/keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=keycloak
      - KC_HOSTNAME=localhost
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - sky-genesis
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\r\nhost: localhost\r\nConnection: close\r\n\r\n' >&3;grep -q '200 OK' <&3"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ================================
  # Reverse Proxy (NGINX)
  # ================================
  nginx:
    image: nginx:alpine
    container_name: sky-genesis-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ../../nginx.conf:/etc/nginx/nginx.conf
      - ../../ssl:/etc/ssl/certs
    depends_on:
      - api
      - frontend
    networks:
      - sky-genesis
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  vault_data:
    driver: local
  redis_data:
    driver: local

networks:
  sky-genesis:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16