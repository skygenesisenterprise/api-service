name: Audit

on:
  schedule:
    - cron: '0 6 1 * *'  # First day of month
  workflow_dispatch:

permissions:
  contents: read
  security-events: read
  actions: read

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Audit npm dependencies
      run: npm audit --audit-level info --json > npm-audit.json

    - name: Audit Rust dependencies
      run: |
        cargo install cargo-audit
        cargo audit --json > cargo-audit.json

    - name: Check for exposed secrets
      run: |
        # Scan for potential secrets in codebase
        patterns=("password" "secret" "key" "token" "api_key")
        for pattern in "${patterns[@]}"; do
          grep -r -i "$pattern" --include="*.rs" --include="*.ts" --include="*.js" . \
            --exclude-dir=node_modules \
            --exclude-dir=target \
            --exclude-dir=.git \
            | grep -v "test" | grep -v "example" > secret-scan-$pattern.txt || true
        done

    - name: Check commit history for secrets
      run: |
        # Check recent commits for accidentally committed secrets
        git log --oneline -50 | while read commit; do
          hash=$(echo $commit | cut -d' ' -f1)
          git show $hash | grep -i "password\|secret\|key\|token" | head -5 > commit-secrets-$hash.txt || true
        done

    - name: Generate security audit report
      run: |
        cat > security-audit-report.md << EOF
        # Security Audit Report
        Generated: $(date)

        ## Dependency Vulnerabilities
        ### NPM
        $(jq '.vulnerabilities | to_entries[] | "- \(.key): \(.value.severity) (\(.value.count) instances)"' npm-audit.json 2>/dev/null || echo "No vulnerabilities found")

        ### Rust
        $(jq '.vulnerabilities.found' cargo-audit.json 2>/dev/null || echo "Audit completed")

        ## Secret Scanning
        $(find . -name "secret-scan-*.txt" -exec sh -c 'echo "### $(basename {})" && cat {} && echo ""' \; 2>/dev/null || echo "No secrets found")

        ## Commit History Review
        $(find . -name "commit-secrets-*.txt" -exec sh -c 'echo "### $(basename {})" && cat {} && echo ""' \; 2>/dev/null || echo "No secrets in commits")

        ## Recommendations
        - Review all findings above
        - Rotate any exposed credentials
        - Update vulnerable dependencies
        - Implement additional security measures if needed
        EOF

    - name: Upload audit report
      uses: actions/upload-artifact@v3
      with:
        name: security-audit-report
        path: |
          security-audit-report.md
          npm-audit.json
          cargo-audit.json
          secret-scan-*.txt
          commit-secrets-*.txt

  access-audit:
    name: Access Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Audit repository access
      run: |
        # Get repository collaborators
        gh api repos/${{ github.repository }}/collaborators --jq '.[] | "\(.login): \(.permissions)"' > collaborators.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Check branch protection
      run: |
        # Verify branch protection rules
        protection=$(gh api repos/${{ github.repository }}/branches/main/protection)
        echo "$protection" | jq '.required_status_checks, .restrictions, .required_pull_request_reviews' > branch-protection.json
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Audit CODEOWNERS
      run: |
        if [ -f .github/CODEOWNERS ]; then
          echo "CODEOWNERS file exists"
          cat .github/CODEOWNERS
        else
          echo "WARNING: CODEOWNERS file missing"
        fi

    - name: Generate access audit report
      run: |
        cat > access-audit-report.md << EOF
        # Access Audit Report
        Generated: $(date)

        ## Repository Collaborators
        $(cat collaborators.txt 2>/dev/null || echo "Unable to retrieve collaborators")

        ## Branch Protection
        $(jq '.' branch-protection.json 2>/dev/null || echo "Branch protection not configured")

        ## CODEOWNERS Status
        $(if [ -f .github/CODEOWNERS ]; then echo "✅ CODEOWNERS configured"; else echo "❌ CODEOWNERS missing"; fi)

        ## Recommendations
        - Ensure least privilege access
        - Regular access reviews
        - Proper branch protection rules
        - CODEOWNERS for critical files
        EOF

    - name: Upload access audit report
      uses: actions/upload-artifact@v3
      with:
        name: access-audit-report
        path: |
          access-audit-report.md
          collaborators.txt
          branch-protection.json

  compliance-audit:
    name: Compliance Audit
    runs-on: ubuntu-latest
    needs: [security-audit, access-audit]

    steps:
    - name: Download audit reports
      uses: actions/download-artifact@v3

    - name: Generate compliance summary
      run: |
        cat > compliance-summary.md << EOF
        # Monthly Compliance Audit Summary
        Generated: $(date)

        ## Audit Results
        - Security Audit: $(if [ -f security-audit-report/security-audit-report.md ]; then echo "✅ Completed"; else echo "❌ Failed"; fi)
        - Access Audit: $(if [ -f access-audit-report/access-audit-report.md ]; then echo "✅ Completed"; else echo "❌ Failed"; fi)

        ## Critical Findings
        $(grep -r "WARNING\|CRITICAL\|HIGH" security-audit-report/ access-audit-report/ 2>/dev/null || echo "No critical findings")

        ## Next Steps
        - Review detailed reports
        - Address any findings
        - Schedule remediation
        - Update policies if needed
        EOF

    - name: Create audit issue
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('compliance-summary.md', 'utf8');

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Monthly Compliance Audit - ${new Date().toISOString().split('T')[0]}`,
            body: summary,
            labels: ['audit', 'compliance', 'monthly']
          });

    - name: Upload final audit package
      uses: actions/upload-artifact@v3
      with:
        name: monthly-audit-package
        path: compliance-summary.md