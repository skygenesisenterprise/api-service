name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ master, develop ]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  pr-checks:
    name: PR Checks
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Validate PR title
      uses: amannn/action-semantic-pull-request@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        types: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          build
          ci
          chore
          revert

    - name: Check PR size
      uses: codacy/git-version@2.7.1
      with:
        release-branch: master
        dev-branch: develop

    - name: Check for merge conflicts
      run: |
        if git diff --name-only HEAD~1 | xargs grep -l "^<<<<<<< "; then
          echo "Merge conflicts detected"
          exit 1
        fi

    - name: Check commit signatures
      run: |
        # Verify commits are signed (optional check)
        echo "Checking commit signatures..."
        git log --oneline --show-signature ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} || echo "Signature check completed"

    - name: Check CODEOWNERS approval
      uses: mszostok/codeowners-validator@v0.7.4
      with:
        checks: "files,duppatterns,syntax"
        owner_checker_allow_unowned_patterns: "false"

    - name: Check for sensitive files
      run: |
        sensitive_files=$(find . -name "*.key" -o -name "*.pem" -o -name "*secret*" -o -name ".env*" | head -10)
        if [ -n "$sensitive_files" ]; then
          echo "Sensitive files detected: $sensitive_files"
          exit 1
        fi

    - name: Validate branch naming
      run: |
        branch="${{ github.head_ref }}"
        if [[ ! "$branch" =~ ^(feature|fix|docs|refactor|test|build|ci)/.+ ]]; then
          echo "Branch name must follow pattern: type/description"
          exit 1
        fi

  security-review:
    name: Security Review
    runs-on: ubuntu-latest
    needs: pr-checks

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 8

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile --ignore-scripts

    - name: Security audit
      run: npm audit --audit-level moderate

    - name: Check for hardcoded secrets
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Comment PR with security findings
      uses: actions/github-script@v6
      if: failure()
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ðŸš¨ **Security Review Failed**\n\nPlease address the security findings before merging.'
          })