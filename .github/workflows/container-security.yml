name: Container Security

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]
  schedule:
    - cron: '0 4 * * 1'  # Weekly

permissions:
  contents: read
  security-events: write

jobs:
  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build containers
      run: |
        docker build -f infrastructure/docker/Dockerfile.api -t api-service:scan .
        docker build -f infrastructure/docker/Dockerfile.frontend -t frontend-service:scan .

    - name: Scan with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'image'
        scan-ref: 'api-service:scan,frontend-service:scan'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'

    - name: Upload Trivy results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: trivy-results.sarif

    - name: Scan with Grype
      uses: anchore/scan-action@v3
      with:
        image: api-service:scan
        fail-build: false
        output-format: sarif
        output-file: grype-api.sarif

    - name: Scan frontend with Grype
      uses: anchore/scan-action@v3
      with:
        image: frontend-service:scan
        fail-build: false
        output-format: sarif
        output-file: grype-frontend.sarif

    - name: Upload Grype results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: grype-api.sarif,grype-frontend.sarif

    - name: Check for critical vulnerabilities
      run: |
        critical_count=$(jq '[.runs[0].results[] | select(.level == "error")] | length' trivy-results.sarif)
        if [ "$critical_count" -gt 0 ]; then
          echo "Critical vulnerabilities found: $critical_count"
          exit 1
        fi

  sbom-generation:
    name: Generate SBOM
    runs-on: ubuntu-latest
    needs: container-scan

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Generate CycloneDX SBOM
      uses: CycloneDX/gh-node-module-generatebom@v1
      with:
        output: sbom.json

    - name: Generate Rust SBOM
      run: |
        cargo install cargo-cyclonedx
        cargo cyclonedx --output-file rust-sbom.json

    - name: Merge SBOMs
      run: |
        npx @cyclonedx/cli merge --input-files sbom.json rust-sbom.json --output-file container-sbom.json

    - name: Upload SBOM
      uses: actions/upload-artifact@v3
      with:
        name: container-sbom
        path: container-sbom.json

  container-hardening:
    name: Container Hardening Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build containers
      run: |
        docker build -f infrastructure/docker/Dockerfile.api -t api-service:harden .
        docker build -f infrastructure/docker/Dockerfile.frontend -t frontend-service:harden .

    - name: Run Docker Bench Security
      run: |
        docker run --rm --net host --pid host --userns host --cap-add audit_control \
          -e DOCKER_CONTENT_TRUST=$DOCKER_CONTENT_TRUST \
          -v /etc:/etc:ro \
          -v /usr/bin/docker:/usr/bin/docker:ro \
          -v /usr/lib/systemd:/usr/lib/systemd:ro \
          -v /var/run/docker.sock:/var/run/docker.sock:ro \
          -v /usr/lib/systemd:/usr/lib/systemd:ro \
          docker/docker-bench-security > docker-bench-results.txt

    - name: Check container hardening
      run: |
        # Check if containers run as non-root
        docker inspect api-service:harden | jq -r '.[0].Config.User' | grep -v "^0\|^root" || echo "WARNING: Container may run as root"

        # Check for unnecessary privileges
        docker inspect api-service:harden | jq '.[0].HostConfig.Privileged' | grep "true" && echo "WARNING: Container has privileged access"

        # Check for exposed ports
        exposed_ports=$(docker inspect api-service:harden | jq '.[0].Config.ExposedPorts | keys[]' | wc -l)
        if [ "$exposed_ports" -gt 3 ]; then
          echo "WARNING: Container exposes many ports: $exposed_ports"
        fi

    - name: Upload hardening report
      uses: actions/upload-artifact@v3
      with:
        name: container-hardening-report
        path: |
          docker-bench-results.txt

  registry-security:
    name: Registry Security
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to registry
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push with security scanning
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./infrastructure/docker/Dockerfile.api
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/api-service:latest
        labels: |
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}

    - name: Sign container
      run: |
        cosign sign ${{ secrets.DOCKER_USERNAME }}/api-service:latest
      env:
        COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}

    - name: Verify signature
      run: |
        cosign verify ${{ secrets.DOCKER_USERNAME }}/api-service:latest --certificate-identity-regexp ".*" --certificate-oidc-issuer-regexp ".*"

    - name: Generate attestation
      run: |
        cosign attest --predicate attestation.json --type custom ${{ secrets.DOCKER_USERNAME }}/api-service:latest
      env:
        COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}