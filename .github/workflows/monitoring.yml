name: Monitoring

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check service health
      run: |
        # Check if main branch is ahead/behind
        git fetch origin
        ahead=$(git rev-list HEAD..origin/main --count)
        behind=$(git rev-list origin/main..HEAD --count)

        if [ "$ahead" -gt 0 ] || [ "$behind" -gt 0 ]; then
          echo "Branch out of sync: $ahead ahead, $behind behind"
          # Could create issue or alert
        fi

    - name: Check for failing workflows
      run: |
        # Check recent workflow runs
        failures=$(gh run list --limit 5 --json conclusion | jq '[.[] | select(.conclusion == "failure")] | length')

        if [ "$failures" -gt 0 ]; then
          echo "Recent workflow failures detected: $failures"
          # Alert team
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Check dependency vulnerabilities
      run: |
        # Check for known vulnerabilities
        curl -s "https://api.github.com/repos/${{ github.repository }}/dependabot/alerts" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          | jq '. | length' > vuln_count.txt

        vuln_count=$(cat vuln_count.txt)
        if [ "$vuln_count" -gt 0 ]; then
          echo "Open security alerts: $vuln_count"
        fi

  metrics-collection:
    name: Collect Metrics
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Collect code metrics
      run: |
        # Code complexity
        npx jscpd --format json > duplication.json

        # Bundle size
        npx webpack-bundle-analyzer build/static/js/*.js --json > bundle-analysis.json

        # Test coverage
        pnpm run test:coverage
        cp coverage/coverage-summary.json .

    - name: Upload metrics
      uses: actions/upload-artifact@v3
      with:
        name: metrics
        path: |
          duplication.json
          bundle-analysis.json
          coverage-summary.json

  alert-monitoring:
    name: Alert Monitoring
    runs-on: ubuntu-latest
    needs: [health-check, metrics-collection]
    if: github.event_name == 'schedule'

    steps:
    - name: Download metrics
      uses: actions/download-artifact@v3
      with:
        name: metrics

    - name: Analyze metrics and create alerts
      run: |
        # Check code duplication
        duplication=$(jq '.duplication.percentage' duplication.json)
        if (( $(echo "$duplication > 5" | bc -l) )); then
          echo "High code duplication: $duplication%"
          # Create alert
        fi

        # Check bundle size
        bundle_size=$(jq '.assets[0].size' bundle-analysis.json)
        if [ "$bundle_size" -gt 5000000 ]; then  # 5MB
          echo "Large bundle size: $bundle_size bytes"
          # Create alert
        fi

        # Check test coverage
        coverage=$(jq '.total.lines.pct' coverage-summary.json)
        if (( $(echo "$coverage < 80" | bc -l) )); then
          echo "Low test coverage: $coverage%"
          # Create alert
        fi

    - name: Create monitoring dashboard
      run: |
        # Generate simple dashboard
        cat > monitoring-dashboard.md << EOF
        # Monitoring Dashboard

        ## Code Quality Metrics
        - Duplication: $(jq '.duplication.percentage' duplication.json)%
        - Bundle Size: $(jq '.assets[0].size' bundle-analysis.json) bytes
        - Test Coverage: $(jq '.total.lines.pct' coverage-summary.json)%

        ## System Health
        - Last Updated: $(date)
        - Repository: ${{ github.repository }}
        EOF

    - name: Update monitoring issue
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const dashboard = fs.readFileSync('monitoring-dashboard.md', 'utf8');

          // Find or create monitoring issue
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['monitoring']
          });

          if (issues.data.length > 0) {
            // Update existing
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issues.data[0].number,
              body: dashboard
            });
          } else {
            // Create new
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Monitoring Dashboard',
              body: dashboard,
              labels: ['monitoring', 'automated']
            });
          }